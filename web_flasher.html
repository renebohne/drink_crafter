<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drink Crafter - Web Flasher</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
        }
        .log-entry {
            font-family: 'Courier New', Courier, monospace;
        }
    </style>
</head>
<body class="text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-lg mx-auto bg-gray-900 rounded-2xl shadow-2xl p-6 md:p-8">
        <div class="text-center mb-6">
            <h1 class="text-3xl font-bold text-blue-400">Drink Crafter</h1>
            <p class="text-gray-400">Web Flasher Utility</p>
        </div>

        <div class="space-y-4">
            <!-- Board Selection -->
            <div>
                <label for="board-select" class="block text-sm font-medium text-gray-300 mb-1">1. Select your board</label>
                <select id="board-select" class="w-full bg-gray-800 border border-gray-700 text-white rounded-lg p-2.5 focus:ring-blue-500 focus:border-blue-500">
                    <option value="esp32dev_8_channel">ESP32 DevKit (8-Channel)</option>
                    <option value="xiao_c6_6channel">XIAO ESP32-C6 (6-Channel)</option>
                </select>
            </div>

            <!-- Connect Button -->
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">2. Connect to ESP32</label>
                <esp-web-install-button id="connect-button" class="w-full">
                    <button slot="activate" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2.5 px-4 rounded-lg transition">Connect</button>
                    <button slot="connected" class="w-full bg-green-600 text-white font-semibold py-2.5 px-4 rounded-lg">Connected</button>
                </esp-web-install-button>
            </div>

            <!-- Erase Option -->
            <div class="form-check flex items-center">
                <input id="erase-flash" type="checkbox" class="w-4 h-4 text-blue-600 bg-gray-700 border-gray-600 rounded focus:ring-blue-600">
                <label for="erase-flash" class="ms-2 text-sm font-medium text-gray-300">Erase flash before installing</label>
            </div>

            <!-- Flash Button -->
            <div>
                <label class="block text-sm font-medium text-gray-300 mb-1">3. Install Drink Crafter</label>
                <button id="flash-button" disabled class="w-full bg-gray-600 text-white font-semibold py-2.5 px-4 rounded-lg cursor-not-allowed">Install</button>
            </div>
        </div>

        <!-- Log Output -->
        <div class="mt-6 bg-gray-800 rounded-lg p-4 h-48 overflow-y-auto border border-gray-700">
            <div id="logs" class="text-sm text-gray-400 space-y-1">
                <p class="log-entry">Welcome! Please connect to your ESP32 to begin.</p>
            </div>
        </div>
    </div>

    <script type="module" src="https://unpkg.com/esp-web-tools@9.4.3/dist/web/install-button.js?module"></script>
    <script>
        const connectButton = document.getElementById('connect-button');
        const flashButton = document.getElementById('flash-button');
        const boardSelect = document.getElementById('board-select');
        const eraseFlashCheckbox = document.getElementById('erase-flash');
        const logsContainer = document.getElementById('logs');

        let device = null;

        const GITHUB_USER = "renebohne";
        const GITHUB_REPO = "drink_crafter";

        const manifests = {
            esp32dev_8_channel: [
                { path: `https://github.com/${GITHUB_USER}/${GITHUB_REPO}/releases/latest/download/bootloader.bin`, offset: 0x1000 },
                { path: `https://github.com/${GITHUB_USER}/${GITHUB_REPO}/releases/latest/download/partitions.bin`, offset: 0x8000 },
                { path: `https://github.com/${GITHUB_USER}/${GITHUB_REPO}/releases/latest/download/firmware.bin`, offset: 0x10000 },
                { path: `https://github.com/${GITHUB_USER}/${GITHUB_REPO}/releases/latest/download/littlefs.bin`, offset: 0x290000 }
            ],
            xiao_c6_6channel: [
                { path: `https://github.com/${GITHUB_USER}/${GITHUB_REPO}/releases/latest/download/bootloader.bin`, offset: 0x0 },
                { path: `https://github.com/${GITHUB_USER}/${GITHUB_REPO}/releases/latest/download/partitions.bin`, offset: 0x8000 },
                { path: `https://github.com/${GITHUB_USER}/${GITHUB_REPO}/releases/latest/download/firmware.bin`, offset: 0x10000 },
                { path: `https://github.com/${GITHUB_USER}/${GITHUB_REPO}/releases/latest/download/littlefs.bin`, offset: 0x290000 }
            ]
        };

        function log(message) {
            const p = document.createElement('p');
            p.className = 'log-entry';
            p.textContent = `> ${message}`;
            logsContainer.appendChild(p);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        connectButton.addEventListener('connected', (e) => {
            device = e.detail.device;
            flashButton.disabled = false;
            flashButton.classList.remove('bg-gray-600', 'cursor-not-allowed');
            flashButton.classList.add('bg-green-600', 'hover:bg-green-700');
            log('Device connected.');
        });

        connectButton.addEventListener('disconnected', () => {
            device = null;
            flashButton.disabled = true;
            flashButton.classList.add('bg-gray-600', 'cursor-not-allowed');
            flashButton.classList.remove('bg-green-600', 'hover:bg-green-700');
            log('Device disconnected.');
        });

        flashButton.addEventListener('click', async () => {
            if (!device) {
                log('Error: Not connected to a device.');
                return;
            }

            flashButton.disabled = true;
            flashButton.textContent = 'Installing...';
            log('Starting installation...');

            try {
                const board = boardSelect.value;
                const manifest = manifests[board];
                
                log(`Fetching manifest for ${board}...`);
                const files = await Promise.all(
                    manifest.map(async ({ path, offset }) => {
                        log(`  - Downloading ${path.split('/').pop()}`);
                        const response = await fetch(path);
                        if (!response.ok) throw new Error(`Failed to download ${path}`);
                        const blob = await response.blob();
                        return { data: await blob.arrayBuffer(), offset };
                    })
                );

                const espTool = await connectButton.getEsptool();
                const erase = eraseFlashCheckbox.checked;

                if (erase) {
                    log('Erasing flash...');
                    await espTool.eraseFlash();
                }

                log('Writing files...');
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    const filename = manifest[i].path.split('/').pop();
                    log(`  - Flashing ${filename} at offset ${file.offset}`);
                    await espTool.writeFlash(file.data, file.offset, (bytesWritten, totalBytes) => {
                        const progress = Math.round((bytesWritten / totalBytes) * 100);
                        flashButton.textContent = `Flashing ${filename}... ${progress}%`;
                    });
                }

                log('Installation complete! Device will now reboot.');
                alert('Drink Crafter has been installed successfully!');

            } catch (error) {
                console.error(error);
                log(`Error: ${error.message}`);
                alert(`Installation failed. Please check the logs and try again.`);
            } finally {
                flashButton.disabled = false;
                flashButton.textContent = 'Install';
            }
        });
    </script>
</body>
</html>
